{% load staticfiles %}
{% load socialaccount %}
{% load static %}

<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Meta Tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="Sisu VR Inc">

    <!-- Title -->
    <title>Sisu VR - Training Portal</title>

    <!-- Styles -->
    <link href="https://fonts.googleapis.com/css?family=Ubuntu" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'portal/plugins/bootstrap/css/bootstrap.min.css' %}" />
    <link rel="stylesheet" href="{% static 'portal/plugins/font-awesome/css/font-awesome.min.css' %}" />
    <link rel="stylesheet" href="{% static 'portal/plugins/icomoon/style.css' %}" />
    <link rel="stylesheet" href="{% static 'portal/plugins/uniform/css/default.css' %}" />

    <!-- Theme Styles -->
    <link rel="stylesheet" href="{% static 'portal/css/space.min.css' %}" />
    <link rel="stylesheet" href="{% static 'portal/css/custom.css' %}" />

    <!-- ChartJS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"
        integrity="sha256-yz7K02nILYEeRDwEfzu/1zI9SpBKod/nLYMTFh7vszs=" crossorigin="anonymous"></script>
</head>

<body style="background: #e0e0e0;">

    <!-- Page Container -->
    <div class="page-container">
        <div class="row" style="margin: auto;">
            {% if play_sessions_completed.count is play_sessions.count %}
            <div id="page1" class="panel panel-white ethi-container" style="height: 720px;">
                <div class="panel-body">
                    <h1 class="ethical-report ethi-text-lg"
                        style="color: #FFDD64; font-weight: bold; text-align: center;">Congratulations on completing the
                        module!</h1>
                    <br /><br />
                    <p class="ethical-report ethi-text-reg">You will now be shown an overview of how you responded and
                        acted throughout the module.<br />
                        This information is designed to provide insights in how your emotions can shape how you respond
                        to harassment scenarios.</p>

                    <div class="vertical-btn-pos ethi-btn-center">
                        <a id="ethiNext1" style="margin-bottom:15px; " type="button"
                            class="btn ethi-btn ethicalBtn">Next</a>
                    </div>
                </div>
            </div>
            {% elif play_sessions_completed.count is not play_sessions.count %}
            <div class="panel panel-white cert-container">
                <div class="panel-body">
                    <h1 class="ethical-report cert-title">Nice Try!</h1>
                    <p class="ethical-report cert-text-reg">The ethical framework report will be generated once
                        all<br>training
                        modules are completed</p>

                    <div style="margin: auto; text-align: center;">
                        <a style="margin-bottom:15px;" type="button" class="btn btn-sisu-primary"
                            href="/portal/home/">Return to training</a>
                    </div>
                </div>
            </div>
            {% endif %}

            {% if not player.supervisor %}
            <div id="page2" class="panel panel-white ethi-container-thin" style="height: 720px; background: #4E657A"
                hidden>
                <p class="ethical-report ethi-text-lg">Let’s see how your <strong>responses</strong> changed over the
                    course of Module 1.</p>
                <p class="ethical-report ethi-text-sm">Hover over each bar for details.</p>
                <!-- style="background: #4E657A; -->
                <div id="container" style="width: 75%">
                    <!-- <canvas id="efr" data-url="{% url 'ethical_report' %}"></canvas> -->
                    <canvas id="efr"></canvas>
                </div>
                <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
                <script src="https://cdn.jsdelivr.net/npm/chart.js@3.5.0/dist/chart.min.js"
                    integrity="sha256-yz7K02nILYEeRDwEfzu/1zI9SpBKod/nLYMTFh7vszs=" crossorigin="anonymous"></script>
                <script>
                    function hoverHandler(e, item) {
                        console.log(item);
                    }

                    var ctx = document.getElementById('efr').getContext('2d');
                    var rawScene = {{ scenes| safe }};
                    var rawEmo = {{ emotions| safe }};
                    var rawBehavior = {{ behaviors| safe }};
                    var rawColor = {{ colors| safe }};
                    var threeColor = {{ three_colors| safe }};

                    function HostileObj(scene, emotion, behavior) {
                        this.scene = scene;
                        this.emotion = emotion;
                        this.behavior = behavior;
                    }
                    function PassiveObj(scene, emotion, behavior) {
                        this.scene = scene;
                        this.emotion = emotion;
                        this.behavior = behavior;
                    }
                    function Confidentobj(scene, emotion, behavior) {
                        this.scene = scene;
                        this.emotion = emotion;
                        this.behavior = behavior;
                    }

                    var hostileArray = new Array();
                    var hostileColor = new Array();
                    var passiveArray = new Array();
                    var passiveColor = new Array();
                    var confidentArray = new Array();
                    var confidentColor = new Array();

                    for (var i = 0; i < rawBehavior.length; i++) {
                        if (rawBehavior[i] == "hostile") {
                            hostileArray.push(new HostileObj(rawScene[i], rawEmo[i], rawBehavior[i]));
                            passiveArray.push(new PassiveObj(rawScene[i], 0, rawBehavior[i]));
                            confidentArray.push(new PassiveObj(rawScene[i], 0, rawBehavior[i]));
                        }
                        else if (rawBehavior[i] == "passive") {
                            passiveArray.push(new PassiveObj(rawScene[i], rawEmo[i], rawBehavior[i]));
                            hostileArray.push(new PassiveObj(rawScene[i], 0, rawBehavior[i]));
                            confidentArray.push(new PassiveObj(rawScene[i], 0, rawBehavior[i]));
                        }
                        else {
                            confidentArray.push(new Confidentobj(rawScene[i], rawEmo[i], rawBehavior[i]));
                            passiveArray.push(new PassiveObj(rawScene[i], 0, rawBehavior[i]));
                            hostileArray.push(new PassiveObj(rawScene[i], 0, rawBehavior[i]));
                        }
                        hostileColor.push(threeColor[0]);
                        passiveColor.push(threeColor[1]);
                        confidentColor.push(threeColor[2]);
                    }

                    var myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: rawScene, //scenes
                            datasets: [{
                                label: "hostile",
                                data: hostileArray,
                                backgroundColor: hostileColor,
                                borderWidth: 1,
                            }, {
                                label: "passive",
                                data: passiveArray,
                                backgroundColor: passiveColor,
                                borderWidth: 1,
                            }, {
                                label: "confident",
                                data: confidentArray,
                                backgroundColor: confidentColor,
                                borderWidth: 1,
                            },]
                        },
                        options: {
                            parsing: {
                                xAxisKey: 'scene',
                                yAxisKey: 'emotion',
                            },
                            responsive: true,
                            title: {
                                display: false,
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Scene',
                                        color: 'white'
                                    },
                                    ticks: {
                                        color: 'white',
                                    },
                                    grid: {
                                        display: false,
                                    },
                                    stacked: true,
                                },

                                y: {
                                    title: {
                                        display: true,
                                        text: 'Emotion',
                                        color: 'white'
                                    },
                                    ticks: {
                                        color: 'white',
                                    },
                                    grid: {
                                        color: 'rgba(255,255,255,0.2)'
                                    },
                                    min: 0,
                                    max: 10
                                }
                            },
                            plugins: {
                                legend: {
                                    onClick: false,
                                    position: 'right',
                                    labels: {
                                        color: 'white',
                                    }
                                },
                                tooltip: {
                                    enabled: false,
                                }
                            },
                            mode: 'nearest',
                            intersect: false,
                            onHover: hoverHandler,
                        }
                    })
                </script>

                <div class="vertical-btn-pos ethi-btn-left">
                    <a id="ethiBack2" style="margin-bottom:15px; " type="button"
                        class="btn ethi-btn ethicalBtn">Back</a>
                </div>
                <div class="vertical-btn-pos ethi-btn-right">
                    <a id="ethiNext2" style="margin-bottom:15px; " type="button"
                        class="btn ethi-btn ethicalBtn">Next</a>
                </div>
            </div>
            {% else %}
            <div id="page2" class="panel panel-white ethi-container-thin" style="height: 720px;" hidden>
                <p class="ethical-report ethi-text-lg">Let’s see employees’ <strong>average responses</strong> in Module
                    1.</p>
                <p class="ethical-report ethi-text-sm">Hover over each bar for details.</p>
                <div id="container" style="position: relative; width: 75%; z-index: 2;">
                    <canvas id="efr_supervisor"></canvas>
                </div>
                <script>
                    // external html tooltip
                    const getOrCreateTooltip = (chart) => {
                        let tooltipEl = chart.canvas.parentNode.querySelector('div');

                        if (!tooltipEl) {
                            tooltipEl = document.createElement('div');
                            tooltipEl.style.background = 'white';
                            tooltipEl.style.fontSize = '14px';
                            tooltipEl.style.width = '280px';
                            tooltipEl.style.borderRadius = '3px';
                            tooltipEl.style.color = 'gray';
                            tooltipEl.style.opacity = 1;
                            tooltipEl.style.pointerEvents = 'none';
                            tooltipEl.style.position = 'absolute';
                            tooltipEl.style.transform = 'translate(10%, -60%)';
                            tooltipEl.style.transition = 'all .1s ease';

                            const table = document.createElement('table');
                            table.style.margin = '5px 5px 15px'; // top margin, left & right margin, bottom margin
                            table.style.width = '255px';

                            tooltipEl.appendChild(table);
                            chart.canvas.parentNode.appendChild(tooltipEl);
                        }

                        return tooltipEl;
                    };

                    const externalTooltipHandler = (context) => {
                        // Tooltip Element
                        const { chart, tooltip } = context;
                        const tooltipEl = getOrCreateTooltip(chart);

                        // Hide if no tooltip
                        if (tooltip.opacity === 0) {
                            tooltipEl.style.opacity = 0;
                            return;
                        }

                        // Styling
                        const contentPadding = '10px';

                        // Set Text
                        // input data from views
                        roleInScene = '{{roles}}'.replace('[', '').replace(']', '').replaceAll('&#39;', '').split(",");
                        avgEmotionInScene = JSON.parse('{{avgEmotions}}');
                        confidentInScene = JSON.parse('{{confident_dataset}}');
                        sceneId = parseInt(tooltip.title[0]) - 1

                        if (tooltip.body) {
                            // title: Scene Review
                            const tableHead = document.createElement('thead');

                            const tr = document.createElement('tr');
                            const th = document.createElement('th');
                            const strong = document.createElement('strong');
                            th.colSpan = '2';
                            th.style.textAlign = 'center';
                            th.style.height = '30px';

                            const text = document.createTextNode('Scene Review');
                            strong.appendChild(text);
                            th.appendChild(strong);
                            tr.appendChild(th);
                            tableHead.appendChild(tr);

                            const tableBody = document.createElement('tbody');

                            // scene image
                            const sceneImg = document.createElement('img');
                            sceneImg.src = '/static/img/demo.gif';
                            sceneImg.style.width = '180px';
                            sceneImg.style.margin = '10px';
                            const imgtr = document.createElement('tr');
                            const imgtd = document.createElement('td');
                            imgtd.colSpan = '2';
                            imgtd.style.textAlign = 'center';

                            imgtd.append(sceneImg);
                            imgtr.append(imgtd);

                            tableBody.appendChild(imgtr);

                            // scene script
                            const scripttr = document.createElement('tr');
                            const scripttd = document.createElement('td');
                            const scriptstrong = document.createElement('strong');
                            scripttd.colSpan = '2';
                            scripttd.style.textAlign = 'center';
                            scripttd.style.color = '#007E9A';

                            const scriptText1 = document.createTextNode("Andy");
                            const scriptText2 = document.createTextNode(": “I’m sorry. I won’t do it again, I promise. Please don’t report to HR.”");

                            scriptstrong.appendChild(scriptText1);
                            scripttd.appendChild(scriptstrong);
                            scripttd.appendChild(scriptText2);
                            scripttr.appendChild(scripttd);

                            tableBody.appendChild(scripttr);

                            // gray line
                            const emptytr = document.createElement('tr');
                            const emptytd = document.createElement('td');
                            emptytd.colSpan = '2';

                            const grayLine = document.createElement('hr');
                            emptytd.appendChild(grayLine);
                            emptytr.appendChild(emptytd);

                            tableBody.appendChild(emptytr);

                            // Employees' role
                            const roletr = document.createElement('tr');
                            const roletd1 = document.createElement('td');
                            const roletd2 = document.createElement('td');
                            const rolestrong = document.createElement('strong');
                            roletd1.style.paddingLeft = contentPadding;
                            roletd2.style.paddingRight = contentPadding;
                            roletd2.align = 'right';

                            const roleText1 = document.createTextNode("Employees' role: ");
                            const roleText2 = document.createTextNode(roleInScene[sceneId]);

                            roletd1.appendChild(roleText1);
                            rolestrong.appendChild(roleText2);
                            roletd2.appendChild(rolestrong);

                            roletr.appendChild(roletd1);
                            roletr.appendChild(roletd2);
                            tableBody.appendChild(roletr);

                            // Employees felt
                            const emotiontr = document.createElement('tr');
                            const emotiontd1 = document.createElement('td');
                            const emotiontd2 = document.createElement('td');
                            const emotionstrong = document.createElement('strong');
                            emotiontd1.style.paddingLeft = contentPadding;
                            emotiontd2.style.paddingRight = contentPadding;
                            emotiontd2.align = 'right';

                            const emotionText1 = document.createTextNode("Employees felt: ");
                            const emotionText2 = document.createTextNode(avgEmotionInScene[sceneId] + " out of 10");

                            emotiontd1.appendChild(emotionText1);
                            emotionstrong.appendChild(emotionText2);
                            emotiontd2.appendChild(emotionstrong);

                            emotiontr.appendChild(emotiontd1);
                            emotiontr.appendChild(emotiontd2);
                            tableBody.appendChild(emotiontr);

                            // Employees acted
                            const acttr = document.createElement('tr');
                            const acttd1 = document.createElement('td');
                            const acttd2 = document.createElement('td');
                            const actstrong = document.createElement('strong');
                            acttd1.style.paddingLeft = contentPadding;
                            acttd2.style.paddingRight = contentPadding;
                            acttd2.align = 'right';
                            acttd2.style.color = '#77B447';

                            const actText1 = document.createTextNode("Employees acted: ");
                            const actText2 = document.createTextNode(parseInt(confidentInScene[sceneId] * 100 / avgEmotionInScene[sceneId]) + "% confident");

                            acttd1.appendChild(actText1);
                            actstrong.appendChild(actText2);
                            acttd2.appendChild(actstrong);

                            acttr.appendChild(acttd1);
                            acttr.appendChild(acttd2);
                            tableBody.appendChild(acttr);


                            const tableRoot = tooltipEl.querySelector('table');

                            // Remove old children
                            while (tableRoot.firstChild) {
                                tableRoot.firstChild.remove();
                            }

                            // Add new children
                            tableRoot.appendChild(tableHead);
                            tableRoot.appendChild(tableBody);
                        }

                        const { offsetLeft: positionX, offsetTop: positionY } = chart.canvas;

                        // Display, position, and set styles for font
                        tooltipEl.style.opacity = 1;
                        tooltipEl.style.left = positionX + tooltip.caretX + 'px';
                        tooltipEl.style.top = positionY + tooltip.caretY + 'px';
                        tooltipEl.style.font = tooltip.options.bodyFont.string;
                        tooltipEl.style.padding = tooltip.options.padding + 'px ' + tooltip.options.padding + 'px';
                    };

                    // render chart
                    var ctx = document.getElementById('efr_supervisor');
                    var myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: JSON.parse('{{labels}}'),
                            datasets: [
                                {
                                    label: 'hostile',
                                    data: JSON.parse('{{hostile_dataset}}'),
                                    backgroundColor: '{{hostile_color}}',
                                    borderWidth: 0
                                },
                                {
                                    label: 'passive',
                                    data: JSON.parse('{{passive_dataset}}'),
                                    backgroundColor: '{{passive_color}}',
                                    borderWidth: 0
                                },
                                {
                                    label: 'confident',
                                    data: JSON.parse('{{confident_dataset}}'),
                                    backgroundColor: '{{confident_color}}',
                                    borderWidth: 0
                                }
                            ]
                        },
                        options: {
                            color: 'white',
                            responsive: true,
                            title: {
                                display: true,
                                text: 'Ethical Framework Report Bar Chart'
                            },
                            scales: {
                                x: {
                                    grid: {
                                        display: false,
                                        borderColor: 'white',
                                        borderWidth: 2,
                                        z: 1,
                                    },
                                    stacked: true,
                                    title: {
                                        color: 'white',
                                        display: true,
                                        text: 'Scene',
                                    },
                                    ticks: {
                                        color: 'white'
                                    }
                                },
                                y: {
                                    grid: {
                                        borderColor: 'white',
                                        borderWidth: 2,
                                        drawTicks: false,
                                        color: 'rgba(255,255,255, 0.3)'
                                    },
                                    stacked: true,
                                    title: {
                                        color: 'white',
                                        display: true,
                                        text: 'Avg. Emotion',
                                    },
                                    ticks: {
                                        color: 'white',
                                        padding: 15
                                    },
                                    min: 0,
                                    max: 10
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true,
                                    position: 'right',
                                    title: {
                                        display: true,
                                    }
                                },
                                tooltip: {
                                    enabled: false,
                                    external: externalTooltipHandler,
                                }
                            }
                        }
                    });
                </script>

                <div class="vertical-btn-pos ethi-btn-left">
                    <a id="ethiBack2" style="margin-bottom:15px; " type="button"
                        class="btn ethi-btn ethicalBtn">Back</a>
                </div>
                <div class="vertical-btn-pos ethi-btn-right">
                    <a id="ethiNext2" style="margin-bottom:15px; " type="button"
                        class="btn ethi-btn ethicalBtn">Next</a>
                </div>
            </div>
            {% endif %}


            <div id="page3" class="panel panel-white ethi-container" style="height: 720px;" hidden>
                <h1 class="ethical-report ethi-text-lg" style="color: #FFDD64; font-weight: bold; text-align: center;">
                    You’re all set! How did you do?</h1>
                <br /><br />
                <p class="ethical-report ethi-text-reg">You can click BACK to review your results again, or exit to the
                    Training Portal.</p>

                <div class="vertical-btn-pos ethi-btn-left">
                    <a id="ethiBack3" style="margin-bottom:15px; " type="button"
                        class="btn ethi-btn ethicalBtn">Back</a>
                </div>
                <div class="vertical-btn-pos ethi-btn-right">
                    <a id="ethiExit3" style="margin-bottom:15px; " type="button"
                        class="btn ethi-btn ethicalBtn">Exit</a>
                </div>

            </div>
        </div>
    </div>


    <!-- /Page Content -->


    <!-- Scripts -->
    <script src="{% static 'portal/plugins/jquery/jquery-3.1.0.min.js' %}"></script>
    <script src="{% static 'portal/plugins/bootstrap/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'portal/plugins/jquery-slimscroll/jquery.slimscroll.min.js' %}"></script>
    <script src="{% static 'portal/plugins/uniform/js/jquery.uniform.standalone.js' %}"></script>

    <script src="{% static 'portal/js/space.js' %}"></script>
    <script src="{% static 'portal/js/scripts.js' %}"></script>
</body>

</html>